// prisma/schema.prisma - UPDATED FOR VOUCHERS PLATFORM
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Locale {
  ar 
  en
}

// ============================================================================
// CORE MODELS
// ============================================================================

model Country {
  id        Int      @id @default(autoincrement())
  code      String   @unique // SA, EG, AE
  currency  String   // SAR, EGP, AED
  flag      String?  // üá∏üá¶
  isActive  Boolean  @default(true)
  isDefault Boolean  @default(false)
  
  translations   CountryTranslation[]
  stores         StoreCountry[]
  vouchers       VoucherCountry[]
  faqs           StoreFAQ[]
  storePayments  StorePaymentMethod[]
  voucherClicks  VoucherClick[]
  otherPromos    OtherPromo[]  // ‚Üê NEW
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([isActive])
}

model CountryTranslation {
  id        Int     @id @default(autoincrement())
  countryId Int
  locale    Locale
  name      String  
  
  country Country @relation(fields: [countryId], references: [id], onDelete: Cascade)
  
  @@unique([countryId, locale])
  @@index([locale])
}

// ============================================================================
// STORE - ENHANCED WITH COVER IMAGE
// ============================================================================

model Store {
  id          Int      @id @default(autoincrement())
  
  // Images
  logo              String?
  backgroundImage   String?   
  coverImage        String?  // ‚úÖ Already exists - hero banner for store page
  color             String?  // Brand color for UI theming
  
  // URLs
  websiteUrl  String
  affiliateNetwork String?
  trackingUrl      String?
  
  // Status
  isActive    Boolean @default(true)
  isFeatured  Boolean @default(false)
  
  // Relations
  translations   StoreTranslation[]
  countries      StoreCountry[]
  vouchers       Voucher[]
  categories     StoreCategory[]
  faqs           StoreFAQ[]
  paymentMethods StorePaymentMethod[]
  otherPromos    OtherPromo[]  // Bank offers, card promos
  products       StoreProduct[] // ‚Üê NEW: Featured products
  
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  
  @@index([isActive])
  @@index([isFeatured])
}

model StoreTranslation {
  id          Int     @id @default(autoincrement())
  storeId     Int
  locale      Locale  
  
  name        String
  slug        String
  description String? @db.Text
  
  // SEO
  seoTitle       String?
  seoDescription String? @db.Text
  
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  
  @@unique([storeId, locale])
  @@unique([locale, slug])
  @@index([locale])
  @@index([slug])
}

// ============================================================================
// CATEGORY - ENHANCED WITH IMAGE
// ============================================================================

model Category {
  id    Int     @id @default(autoincrement())
  icon  String? // Material icon name (e.g., "checkroom", "devices")
  image String? // ‚úÖ Already exists - category banner/thumbnail
  color String? // Category accent color
  
  translations CategoryTranslation[]
  stores       StoreCategory[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CategoryTranslation {
  id         Int    @id @default(autoincrement())
  categoryId Int
  locale     Locale
  
  name        String
  slug        String
  description String? @db.Text
  
  seoTitle       String?
  seoDescription String? @db.Text
  
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  @@unique([categoryId, locale])
  @@unique([locale, slug])
  @@index([locale])
  @@index([slug])
}

// ============================================================================
// VOUCHER - COUPONS & DEALS
// ============================================================================

model Voucher {
  id       Int         @id @default(autoincrement())
  storeId  Int
  
  // Voucher Details
  code     String?     // Coupon code (e.g., "SAVE20")
  type     VoucherType
  discount String?     // "20%", "50 SAR off", "Buy 1 Get 1"
  
  // Image for featured deals
  image    String?     // Hero image for visual deals
  
  // Links
  landingUrl String?   // Direct product/deal URL
  
  // Validity
  startDate  DateTime?
  expiryDate DateTime?
  
  // Badges
  isExclusive Boolean @default(false)
  isVerified  Boolean @default(false)
  
  // Analytics
  popularityScore Int @default(0)
  
  // Relations
  translations VoucherTranslation[]
  countries    VoucherCountry[]
  store        Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  clicks       VoucherClick[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([storeId])
  @@index([expiryDate])
  @@index([isExclusive])
  @@index([isVerified])
  @@index([popularityScore])
}

model VoucherTranslation {
  id        Int    @id @default(autoincrement())
  voucherId Int
  locale    Locale
  
  title       String        // "20% Off Everything"
  description String? @db.Text // "Valid on all items. Min spend 200 SAR"
  
  voucher Voucher @relation(fields: [voucherId], references: [id], onDelete: Cascade)
  
  @@unique([voucherId, locale])
  @@index([locale])
}

enum VoucherType {
  CODE           // Requires coupon code
  DEAL           // Auto-applied deal
  FREE_SHIPPING  // Free shipping offer
}

// ============================================================================
// STORE PRODUCTS - FEATURED ITEMS
// ============================================================================

 model StoreProduct {
   id          Int     @id @default(autoincrement())
   storeId     Int
   
   // Product Details
   image       String  // Product image (required)
  discountValue Float?        // Discount amount (percentage or absolute)
  discountType  DiscountType @default(PERCENTAGE) // PERCENTAGE or ABSOLUTE
   
   // Links
   productUrl  String  // Direct link to product on store website
   
   // Display
   isFeatured  Boolean @default(true)  // Show on store page
   order       Int     @default(0)     // Display order
   
   // Analytics
   clickCount  Int     @default(0)
   
   // Relations
   translations StoreProductTranslation[]
   store        Store   @relation(fields: [storeId], references: [id], onDelete: Cascade)
   clicks       StoreProductClick[]
   
   createdAt   DateTime @default(now())
   updatedAt   DateTime @updatedAt
   
   @@index([storeId])
   @@index([isFeatured])
   @@index([order])
 }

enum DiscountType {
  PERCENTAGE
  ABSOLUTE
}

model StoreProductTranslation {
  id        Int    @id @default(autoincrement())
  productId Int
  locale    Locale
  
  title       String        // "iPhone 15 Pro Max 256GB"
  description String? @db.Text // Optional product description
  
  product StoreProduct @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@unique([productId, locale])
  @@index([locale])
}

model StoreProductClick {
  id          Int      @id @default(autoincrement())
  productId   Int
  
  ipHash      String?
  userAgent   String?
  referrer    String?
  clickedAt   DateTime @default(now())
  
  product StoreProduct @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  @@index([productId])
  @@index([clickedAt])
}

// ============================================================================
// OTHER PROMOS - NEW MODEL FOR BANK/CARD OFFERS
// ============================================================================

model OtherPromo {
  id        Int     @id @default(autoincrement())
  storeId   Int
  countryId Int
  
  // Promo Details
  image     String?    // Banner image
  type      PromoType
  
  // Links
  url       String?    // External link to T&Cs or signup
  
  // Validity
  startDate  DateTime?
  expiryDate DateTime?
  
  isActive   Boolean @default(true)
  order      Int     @default(0) // Display order
  
  // Relations
  translations OtherPromoTranslation[]
  store        Store   @relation(fields: [storeId], references: [id], onDelete: Cascade)
  country      Country @relation(fields: [countryId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([storeId, countryId])
  @@index([isActive])
}

model OtherPromoTranslation {
  id      Int    @id @default(autoincrement())
  promoId Int
  locale  Locale
  
  title       String        // "10% Cashback with Visa"
  description String? @db.Text // "Get 10% cashback when you pay with Visa cards"
  terms       String? @db.Text // Full terms & conditions
  
  promo OtherPromo @relation(fields: [promoId], references: [id], onDelete: Cascade)
  
  @@unique([promoId, locale])
  @@index([locale])
}

enum PromoType {
  BANK_OFFER      // "15% off with SABB"
  CARD_OFFER      // "Extra 10% with Visa"
  PAYMENT_OFFER   // "5% cashback via STC Pay"
  SEASONAL        // "Ramadan Special"
  BUNDLE          // "Buy 2 Get 1 Free"
  OTHER
}

// ============================================================================
// PAYMENT METHODS
// ============================================================================

model PaymentMethod {
  id          Int      @id @default(autoincrement())
  slug        String   @unique
  type        PaymentType
  isBnpl      Boolean  @default(false)
  logo        String?
  
  translations PaymentMethodTranslation[]
  storeLinks   StorePaymentMethod[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([type])
  @@index([isBnpl])
}

model PaymentMethodTranslation {
  id              Int     @id @default(autoincrement())
  paymentMethodId Int
  locale          Locale
  
  name        String
  description String? @db.Text
  
  paymentMethod PaymentMethod @relation(fields: [paymentMethodId], references: [id], onDelete: Cascade)
  
  @@unique([paymentMethodId, locale])
  @@index([locale])
}

enum PaymentType {
  CARD
  BNPL
  COD
  WALLET
  BANK_TRANSFER
}

model StorePaymentMethod {
  id              Int      @id @default(autoincrement())
  storeId         Int
  countryId       Int
  paymentMethodId Int
  
  isActive        Boolean  @default(true)
  minAmount       Float?
  maxAmount       Float?
  
  store           Store         @relation(fields: [storeId], references: [id], onDelete: Cascade)
  country         Country       @relation(fields: [countryId], references: [id], onDelete: Cascade)
  paymentMethod   PaymentMethod @relation(fields: [paymentMethodId], references: [id], onDelete: Cascade)
  
  translations    StorePaymentMethodTranslation[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@unique([storeId, countryId, paymentMethodId])
  @@index([storeId, countryId])
}

model StorePaymentMethodTranslation {
  id                  Int     @id @default(autoincrement())
  storePaymentMethodId Int
  locale              Locale
  
  notes String? @db.Text
  
  storePaymentMethod StorePaymentMethod @relation(fields: [storePaymentMethodId], references: [id], onDelete: Cascade)
  
  @@unique([storePaymentMethodId, locale])
  @@index([locale])
}

// ============================================================================
// STORE FAQ
// ============================================================================

model StoreFAQ {
  id        Int     @id @default(autoincrement())
  storeId   Int
  countryId Int
  order     Int     @default(0)
  isActive  Boolean @default(true)
  
  translations StoreFAQTranslation[]
  store        Store   @relation(fields: [storeId], references: [id], onDelete: Cascade)
  country      Country @relation(fields: [countryId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([storeId, countryId, order])
  @@index([storeId, countryId])
  @@index([isActive])
}

model StoreFAQTranslation {
  id    Int    @id @default(autoincrement())
  faqId Int
  locale Locale
  
  question String
  answer   String @db.Text
  
  faq StoreFAQ @relation(fields: [faqId], references: [id], onDelete: Cascade)
  
  @@unique([faqId, locale])
  @@index([locale])
}

// ============================================================================
// JUNCTION TABLES
// ============================================================================

model StoreCountry {
  storeId   Int
  countryId Int
  
  store   Store   @relation(fields: [storeId], references: [id], onDelete: Cascade)
  country Country @relation(fields: [countryId], references: [id], onDelete: Cascade)
  
  @@id([storeId, countryId])
}

model VoucherCountry {
  voucherId Int
  countryId Int
  
  voucher Voucher @relation(fields: [voucherId], references: [id], onDelete: Cascade)
  country Country @relation(fields: [countryId], references: [id], onDelete: Cascade)
  
  @@id([voucherId, countryId])
}

model StoreCategory {
  storeId    Int
  categoryId Int
  
  store    Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  
  @@id([storeId, categoryId])
}

// ============================================================================
// ANALYTICS
// ============================================================================

model VoucherClick {
  id          Int      @id @default(autoincrement())
  voucherId   Int
  countryId   Int?
  
  ipHash      String?
  userAgent   String?
  referrer    String?
  clickedAt   DateTime @default(now())
  
  voucher Voucher @relation(fields: [voucherId], references: [id], onDelete: Cascade)
  country Country? @relation(fields: [countryId], references: [id], onDelete: SetNull)
  
  @@index([voucherId])
  @@index([clickedAt])
  @@index([countryId])
}

// ============================================================================
// ADMIN
// ============================================================================

model Admin {
  id           String    @id @default(cuid())
  email        String    @unique
  name         String?
  password     String
  role         AdminRole @default(ADMIN)
  permissions  String[]
  isActive     Boolean   @default(true)
  lastLoginAt  DateTime?
  resetToken   String?
  resetExpires DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([role])
  @@index([isActive])
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  EDITOR
  VIEWER
}
